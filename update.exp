#!/usr/bin/expect -f


# ======================
# é€šç”¨å‡½æ•°: å®‰å…¨æ‰§è¡Œ spawn
# ======================
proc safe_spawn {cmd password retries} {
    set attempt 1
    while {$attempt <= $retries} {
        puts "ðŸ”„ å°è¯•ç¬¬ $attempt æ¬¡æ‰§è¡Œ: $cmd"
        if {[catch {spawn {*}$cmd} result]} {
            puts "âŒ spawn æ‰§è¡Œå¤±è´¥: $result"
            incr attempt
            after 2000
            continue
        }
        expect {
            "*assword:" { send "$password\r" }
            timeout {
                puts "â° SSH è¶…æ—¶ï¼Œé‡è¯•..."
                incr attempt
                after 2000
                continue
            }
        }
        expect {
            eof {
                return $expect_out(buffer)
            }
            timeout { puts "â° æ‰§è¡Œè¶…æ—¶ï¼Œé‡è¯•..."; incr attempt; after 2000 }
        }
    }
    puts "âŒ å¤šæ¬¡é‡è¯•å¤±è´¥ï¼Œæ”¾å¼ƒ: $cmd"
    exit 1
}


# ======================
# é…ç½®
# ======================
set timeout 30
set password "root"
set user "root"
set host "10.140.32.25"
set local_path [lindex $argv 0]
set remote_dir "/opt/spc-simulator-py"

puts "\033\[31m âœ… å¼€å§‹æ›´æ–°ä»£ç : spc-simulator-py \033\[0m"
puts "âœ… local_path å€¼ä¸º = $local_path"
after 5000


# ======================
# 1. ä¸Šä¼  $local_path ä¸‹çš„ .git æ–‡ä»¶å¤¹åˆ°æœåŠ¡å™¨
# ======================
set scp_cmd "scp -r -o ConnectTimeout=10 $local_path/.git $user@$host:$remote_dir/"
safe_spawn [list {*}$scp_cmd] $password 3
puts "âœ… ä¸Šä¼ å®Œæˆ: $local_path å·²ä¸Šä¼ åˆ° $remote_dir"

# ======================
# 2. SSH ç™»å½•æ‰§è¡Œæ›´æ–°å‘½ä»¤
# ======================
puts "\033\[33m âš™ï¸  å¼€å§‹è¿œç¨‹æ‰§è¡Œ git æ›´æ–°å‘½ä»¤... \033\[0m"

set remote_cmd "
    cd $remote_dir && \
    export http_proxy=http://10.140.32.80:7897 && \
    export https_proxy=http://10.140.32.80:7897 && \
    export all_proxy=socks5://10.140.32.80:7897 && \
    echo 'ðŸŒ Proxy å·²è®¾ç½®æˆåŠŸ' && \
    git fetch && \
    git reset --hard origin/main && \
    git pull && \
    rm -rf $remote_dir/.git && \
    echo 'âœ… ä»£ç æ›´æ–°å®Œæˆ'
"

set ssh_cmd [list ssh -o ConnectTimeout=10 "$user@$host" "$remote_cmd"]
safe_spawn $ssh_cmd $password 3

puts "\033\[32m ðŸŽ‰ æ‰€æœ‰æ“ä½œå®Œæˆï¼\033\[0m"
